<div
  data-controller="calendrier"
  data-calendrier-index-value="<%= @initial_index %>"
  class="pillami-calendar-container"
>
  <div class="pillami-calendar-main">
    <div class="pillami-calendar-header">
      <!-- Titre semaine -->
      <div>
        <% if current_user && current_user != @user %>
          <% owner_name = @user.try(:prenom).presence || @user.try(:nom).presence || @user.email.split('@').first %>
          <div class="pillami-calendar-owner">
            <div class="pillami-calendar-owner-avatar">
              <% if @user.photo.attached? %>
                <%= cl_image_tag @user.photo.key, crop: :fill, width: 48, height: 48, class: "pillami-calendar-owner-img" %>
              <% else %>
                <span><%= owner_name.first.upcase %></span>
              <% end %>
            </div>
            <div class="pillami-calendar-owner-info">
              <p>Calendrier de</p>
              <strong><%= owner_name %></strong>
            </div>
          </div>
        <% end %>
        <h1 class="pillami-calendar-week-range">
          <%= l(@week_days.first, format: "%d %B") %> — <%= l(@week_days.last, format: "%d %B %Y") %>
        </h1>
      </div>

      <!-- Nav semaines -->
      <div class="pillami-calendar-nav">
        <%= link_to user_calendrier_path(@user, date: @week_start - 7),
            class: "pillami-calendar-nav-btn" do %>
          <span class="pillami-calendar-nav-text-full">◀︎ Semaine précédente</span>
          <span class="pillami-calendar-nav-text-short">◀︎ Préc.</span>
        <% end %>

        <%= link_to user_calendrier_path(@user, date: @week_start + 7),
            class: "pillami-calendar-nav-btn" do %>
          <span class="pillami-calendar-nav-text-full">Semaine suivante ▶︎</span>
          <span class="pillami-calendar-nav-text-short">Suiv. ▶︎</span>
        <% end %>
      </div>

      <!-- CARROUSEL -->
      <div class="pillami-calendar-carousel">
        <!-- bouton précédent -->
        <button
          type="button"
          data-action="click->calendrier#prev"
          class="pillami-calendar-carousel-btn pillami-calendar-carousel-btn-prev flex items-center justify-center"
          aria-label="Jour précédent"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="size-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        <!-- fenêtre -->
        <div class="pillami-calendar-carousel-window">
          <!-- piste qui bouge + swipe -->
          <div
            data-calendrier-target="track"
            data-action="
              touchstart->calendrier#touchStart
              touchend->calendrier#touchEnd
            "
            class="pillami-calendar-carousel-track"
          >
            <% @week_days.each do |date| %>
              <% reminders_for_day = @reminders_by_day[date] || [] %>
              <% sensations_for_day = @sensations_by_day[date] || [] %>
              <% taken_for_day = @taken_by_day[date] || {} %>

              <!-- 1 SLIDE = 1 JOUR -->
              <div
                data-calendrier-target="day"
                data-action="click->calendrier#select"
                data-date="<%= date %>"
                data-weekday="<%= l(date, format: '%A') %>"
                data-month="<%= l(date, format: '%B') %>"
                class="pillami-calendar-day-slide"
              >
                <div class="pillami-calendar-day-circle">
                  <div class="pillami-calendar-day-content">
                    <p class="pillami-calendar-day-name">
                      <%= l(date, format: "%A") %>
                    </p>
                    <p class="pillami-calendar-day-number" data-role="day-number">
                      <%= date.day %>
                    </p>
                    <p class="pillami-calendar-day-month">
                      <%= l(date, format: "%B") %>
                    </p>
                  </div>
                </div>

                <!-- TEMPLATE HTML DES RAPPELS POUR CE JOUR -->
                <template data-calendrier-target="template">
                  <%= render partial: "reminder_panel",
                             locals: { reminders: reminders_for_day, sensations: sensations_for_day, day: date.day, taken: taken_for_day } %>
                </template>
              </div>
            <% end %>
          </div>
        </div>

        <!-- bouton suivant -->
        <button
          type="button"
          data-action="click->calendrier#next"
          class="pillami-calendar-carousel-btn pillami-calendar-carousel-btn-next flex items-center justify-center"
          aria-label="Jour suivant"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="size-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>

      <!-- PANEL GLOBAL SOUS LE CARROUSEL -->
      <div
        data-calendrier-target="panel"
        class="pillami-calendar-panel"
      ></div>
    </div>

    <%= render "shared/back_button" %>
  </div>
</div>

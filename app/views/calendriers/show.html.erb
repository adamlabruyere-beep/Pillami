<div
  data-controller="calendrier"
  data-calendrier-index-value="<%= @initial_index %>"
  class="pillami-calendar-container min-h-screen flex flex-col items-center justify-start pt-15"
>
  <div class="pillami-calendar-main container mx-auto">
    <div class="pillami-calendar-header justify-items-center items-center text-center space-y-8">
      <!-- Titre semaine -->
      <div>
        <p class="pillami-calendar-week-title-label">Semaine du</p>
        <h1 class="pillami-calendar-week-range">
          <%= l(@week_days.first, format: "%d %B") %> — <%= l(@week_days.last, format: "%d %B %Y") %>
        </h1>
      </div>

      <!-- Nav semaines -->
      <div class="pillami-calendar-nav flex items-center justify-between">
        <%= link_to "◀︎ Semaine précédente",
            user_calendrier_path(@user, date: @week_start - 7),
            class: "pillami-calendar-nav-btn px-4 py-2 border rounded-lg" %>

        <%= link_to "Semaine suivante ▶︎",
            user_calendrier_path(@user, date: @week_start + 7),
            class: "pillami-calendar-nav-btn px-4 py-2 border rounded-lg" %>
      </div>

      <!-- CARROUSEL -->
      <div class="pillami-calendar-carousel relative w-full max-w-sm mx-auto mt-4">
        <!-- bouton précédent -->
        <button
          type="button"
          data-action="click->calendrier#prev"
          class="pillami-calendar-carousel-btn pillami-calendar-carousel-btn-prev absolute left-2 top-1/2 -translate-y-1/2
                 md:-translate-x-full px-3 py-2 border rounded-full text-sm"
        >
          ◀
        </button>

        <!-- fenêtre -->
        <div class="pillami-calendar-carousel-window overflow-hidden">
          <!-- piste qui bouge + swipe -->
          <div
            data-calendrier-target="track"
            data-action="
              touchstart->calendrier#touchStart
              touchend->calendrier#touchEnd
            "
            class="pillami-calendar-carousel-track flex transition-transform duration-300 ease-out"
          >
            <% @week_days.each do |date| %>
              <% reminders_for_day = @reminders_by_day[date] || [] %>
              <% sensations_for_day = @sensations_by_day[date] || [] %>

              <!-- 1 SLIDE = 1 JOUR -->
              <div
                data-calendrier-target="day"
                data-action="click->calendrier#select"
                data-date="<%= date %>"
                data-weekday="<%= l(date, format: '%A') %>"
                data-month="<%= l(date, format: '%B') %>"
                class="pillami-calendar-day-slide min-w-full flex justify-center"
              >
                <div class="pillami-calendar-day-circle w-40 aspect-square rounded-full border border-black
                            flex items-center justify-center cursor-pointer">
                  <div class="pillami-calendar-day-content flex flex-col items-center text-center px-4 py-6 space-y-1">
                    <p class="pillami-calendar-day-name text-sm leading-tight">
                      <%= l(date, format: "%A") %>
                    </p>
                    <p class="pillami-calendar-day-number text-3xl font-semibold leading-none" data-role="day-number">
                      <%= date.day %>
                    </p>
                    <p class="pillami-calendar-day-month text-sm leading-tight">
                      <%= l(date, format: "%B") %>
                    </p>
                  </div>
                </div>

                <!-- TEMPLATE HTML DES RAPPELS POUR CE JOUR -->
                <template data-calendrier-target="template">
                  <%= render partial: "reminder_panel",
                             locals: { reminders: reminders_for_day, sensations: sensations_for_day } %>
                </template>
              </div>
            <% end %>
          </div>
        </div>

        <!-- bouton suivant -->
        <button
          type="button"
          data-action="click->calendrier#next"
          class="pillami-calendar-carousel-btn pillami-calendar-carousel-btn-next absolute right-2 top-1/2 -translate-y-1/2
                 md:translate-x-full px-3 py-2 border rounded-full text-sm"
        >
          ▶
        </button>
      </div>

      <!-- PANEL GLOBAL SOUS LE CARROUSEL -->
      <div
        data-calendrier-target="panel"
        class="pillami-calendar-panel mt-6 max-w-sm mx-auto"
      ></div>
    </div>
  </div>
</div>

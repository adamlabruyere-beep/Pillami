<div class="pillami-page-form-wrapper">
  <div class="pillami-page-form">
    <div class="pillami-form-container">

      <!-- HEADER -->
      <div class="pillami-form-header">
        <h2 class="pillami-form-title">Ajouter un rappel</h2>
        <p class="pillami-form-subtitle">Choisissez votre médicament et configurez le rappel</p>
      </div>

      <%= form_with model: [@user, @reminder], local: true, data: { controller: "medicament-format" } do |f| %>

        <!-- ERREURS -->
        <% if @reminder.errors.any? %>
          <div class="pillami-form-error">
            <h3>Veuillez corriger les erreurs ci-dessous :</h3>
            <ul>
              <% @reminder.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- MEDICAMENT -->
        <div class="pillami-input-block">
          <%= f.label :medicament_id, "Médicament", class: "pillami-label" %>
          <select
            name="reminder[medicament_id]"
            id="reminder_medicament_id"
            class="pillami-input"
            data-medicament-format-target="select"
            data-action="change->medicament-format#updateMeasure">
            <option value="">Sélectionnez un médicament</option>
            <% @medicaments.each do |med| %>
              <option value="<%= med.id %>" data-format="<%= med.format %>"><%= med.nom %></option>
            <% end %>
          </select>
        </div>

        <!-- CHOIX DES JOURS -->
        <fieldset class="pillami-days" data-controller="select-all-days">
          <legend class="pillami-days-title">Choisissez les jours</legend>

          <% selected_days = @reminder.days_of_week || [] %>

          <div class="pillami-days-grid">
            <!-- Tous les jours -->
            <label class="pillami-day-item">
              <input type="checkbox"
                     data-select-all-days-target="selectAll"
                     data-action="change->select-all-days#toggleAll">
              <span>Tous les jours</span>
            </label>

            <% Date::DAYNAMES.rotate(1).each do |day| %>
              <label class="pillami-day-item">
                <%= check_box_tag "reminder[days_of_week][]", day, selected_days.include?(day),
                  data: { select_all_days_target: "day", action: "change->select-all-days#updateSelectAll" } %>
                <span><%= I18n.t("date.day_names")[Date::DAYNAMES.index(day)] %></span>
              </label>
            <% end %>
          </div>
        </fieldset>

        <!-- Jours sélectionnés -->
        <p class="pillami-selected-days">
          Jours :
          <%= @reminder.days_of_week&.map { |d| I18n.t("date.day_names")[Date::DAYNAMES.index(d)] }&.join(", ") || "Aucun" %>
        </p>

        <!-- REPETITION SEMAINES -->
        <div class="pillami-input-block">
          <%= f.label :repeat_for_weeks, "Répéter pendant (semaines)", class: "pillami-label" %>
          <%= f.number_field :repeat_for_weeks, min: 1, value: 1, class: "pillami-input" %>
        </div>

        <!-- HEURE -->
        <div class="pillami-input-block">
          <%= f.label :time, "Heure du rappel", class: "pillami-label" %>
          <div style="display: flex; gap: 8px; align-items: center;">
            <%= f.time_select :time, { minute_step: 10 }, { style: "flex: 1; padding: 14px; border: 1px solid #bbb; border-radius: 10px; font-size: 16px; background: white;" } %>
          </div>
        </div>

        <!-- QUANTITE + MESURE -->
        <div class="pillami-row">
          <div>
            <%= f.label :quantity, "Quantité", class: "pillami-label" %>
            <%= f.select :quantity, [1,2,3,4,5], {},
                  data: { medicament_format_target: "quantity" },
                  class: "pillami-input" %>
          </div>
          <div>
            <%= f.label :measure, "Mesure", class: "pillami-label" %>
            <%= f.select :measure,
                  ['Comprimé','Demi comprimé','Gélule','Capsule','Cuillère à café','Cuillère à soupe','Gouttes','Ampoule','Sachet','Patch','Injection','ml','mg','Dose'],
                  {},
                  data: { medicament_format_target: "measure", action: "change->medicament-format#updateQuantityOptions" },
                  class: "pillami-input" %>
          </div>
        </div>

        <!-- BOUTON SOUMETTRE -->
        <%= f.submit "Créer le rappel", class: "pillami-submit" %>

      <% end %>

      <!-- LIEN RETOUR -->
      <div class="pillami-back">
        <%= link_to "← Retour", user_reminders_path(@user), class: "pillami-back-link" %>
      </div>

    </div>
  </div>
</div>
